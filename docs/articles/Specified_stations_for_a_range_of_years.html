<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GSODR use case: Specified years/stations vignette • GSODR</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">GSODR</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/ropensci/GSODR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>GSODR use case: Specified years/stations vignette</h1>
                        <h4 class="author">Adam H Sparks</h4>
            
            <h4 class="date">2017-02-06</h4>
          </div>

    
    
<div class="contents">
<div id="gather-data-for-irri-central-luzon-survey-loop" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#gather-data-for-irri-central-luzon-survey-loop" class="anchor"> </a></body></html>Gather Data for IRRI Central Luzon Survey Loop</h1>
<p>The IRRI (International Rice Research Institute) survey loop in Central Luzon is a study that aims to monitor the changes in rice farming in the major rice producing area of the Philippines - the Central Luzon region, which is called as the “rice bowl of the Philippines”. Data have been collected in this project since the 1960s. See, <a href="http://ricestat.irri.org/fhsd/php/panel.php?page=1&amp;sortBy=title&amp;sortOrder=ascending#" class="uri">http://ricestat.irri.org/fhsd/php/panel.php?page=1&amp;sortBy=title&amp;sortOrder=ascending#</a> for the panel data.</p>
<p>This vignette details how to find and retrieve weather data for the area that this survey covers for the time period of 1960-2016. Methods that are detailed include: * retrieving a spatial object of provincial level data; * subsetting this data for the provinces of interest; * merging the polygons into one object; * finding the centroid of this resulting polygon; * using the centroid of the polygon to find stations within 100km of this point; * determining which stations provide data for the specified time-period, 1960-2016; and * downloading the station files and creating a single CSV file of the data.</p>
<div id="retrieve-phl-provincial-data-and-select-loop-provinces" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#retrieve-phl-provincial-data-and-select-loop-provinces" class="anchor"> </a></body></html>Retrieve PHL Provincial Data and Select Loop Provinces</h2>
<p>First we retrieve data from GADM.org that will provide the provincial spatial data for the survey area. We will then use this to find the centroid, which will be used to find the nearest stations.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(raster)
<span class="kw">library</span>(rgdal)

RP &lt;-<span class="st"> </span><span class="kw">getData</span>(<span class="dt">country =</span> <span class="st">"Philippines"</span>, <span class="dt">level =</span> <span class="dv">1</span>)</code></pre></div>
<p>Select the provinces involved in the survey and make a new object called <code>Central_Luzon</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Central_Luzon &lt;-<span class="st"> </span>RP[RP<span class="op">@</span>data<span class="op">$</span>NAME_<span class="dv">1</span> <span class="op">==</span><span class="st"> "Pampanga"</span> <span class="op">|</span><span class="st"> </span>
<span class="st">           </span>RP<span class="op">@</span>data<span class="op">$</span>NAME_<span class="dv">1</span> <span class="op">==</span><span class="st"> "Tarlac"</span> <span class="op">|</span>
<span class="st">           </span>RP<span class="op">@</span>data<span class="op">$</span>NAME_<span class="dv">1</span> <span class="op">==</span><span class="st"> "Pangasinan"</span> <span class="op">|</span>
<span class="st">           </span>RP<span class="op">@</span>data<span class="op">$</span>NAME_<span class="dv">1</span> <span class="op">==</span><span class="st"> "La Union"</span> <span class="op">|</span>
<span class="st">           </span>RP<span class="op">@</span>data<span class="op">$</span>NAME_<span class="dv">1</span> <span class="op">==</span><span class="st"> "Nueva Ecija"</span> <span class="op">|</span>
<span class="st">           </span>RP<span class="op">@</span>data<span class="op">$</span>NAME_<span class="dv">1</span> <span class="op">==</span><span class="st"> "Bulacan"</span>, ]</code></pre></div>
</div>
<div id="dissolve-polygons-and-find-centroid-of-loop-survey-area" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#dissolve-polygons-and-find-centroid-of-loop-survey-area" class="anchor"> </a></body></html>Dissolve Polygons and Find Centroid of Loop Survey Area</h2>
<p>Now that we have the provincial data imported, we will dissolve the polygons and find the centroid.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(rgeos)
Central_Luzon &lt;-<span class="st"> </span><span class="kw">gUnaryUnion</span>(Central_Luzon)
centroid &lt;-<span class="st"> </span><span class="kw">gCentroid</span>(Central_Luzon)</code></pre></div>
<p>Next, make a list of stations that are within this area.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(GSODR)
<span class="kw">library</span>(readr)
<span class="co"># Fetch station list from NCDC</span>
station_meta &lt;-<span class="st"> </span><span class="kw">read_csv</span>(
  <span class="st">"ftp://ftp.ncdc.noaa.gov/pub/data/noaa/isd-history.csv"</span>,
  <span class="dt">col_types =</span> <span class="st">"ccccccddddd"</span>,
  <span class="dt">col_names =</span> <span class="kw">c</span>(<span class="st">"USAF"</span>, <span class="st">"WBAN"</span>, <span class="st">"STN_NAME"</span>, <span class="st">"CTRY"</span>, <span class="st">"STATE"</span>, <span class="st">"CALL"</span>, <span class="st">"LAT"</span>,
                <span class="st">"LON"</span>, <span class="st">"ELEV_M"</span>, <span class="st">"BEGIN"</span>, <span class="st">"END"</span>), <span class="dt">skip =</span> <span class="dv">1</span>)
station_meta<span class="op">$</span>STNID &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="kw">paste</span>(station_meta<span class="op">$</span>USAF,
                                         station_meta<span class="op">$</span>WBAN,
                                         <span class="dt">sep =</span> <span class="st">"-"</span>))

loop_stations &lt;-<span class="st"> </span><span class="kw"><a href="../reference/nearest_stations.html">nearest_stations</a></span>(<span class="dt">LAT =</span> centroid<span class="op">@</span>coords[, <span class="dv">2</span>],
                                  <span class="dt">LON =</span> centroid<span class="op">@</span>coords[, <span class="dv">1</span>], 
                                  <span class="dt">distance =</span> <span class="dv">100</span>)

loop_stations &lt;-<span class="st"> </span>station_meta[station_meta<span class="op">$</span>STNID <span class="op">%in%</span><span class="st"> </span>loop_stations, ]

loop_stations &lt;-<span class="st"> </span>loop_stations[loop_stations<span class="op">$</span>BEGIN <span class="op">&lt;=</span><span class="st"> </span><span class="dv">19591231</span> <span class="op">&amp;</span>
<span class="st">                                 </span>loop_stations<span class="op">$</span>END <span class="op">&gt;=</span><span class="st"> </span><span class="dv">20151231</span>, ]</code></pre></div>
</div>
<div id="using-get_gsod-to-fetch-the-requested-station-files" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#using-get_gsod-to-fetch-the-requested-station-files" class="anchor"> </a></body></html>Using get_GSOD to Fetch the Requested Station Files</h2>
<p>Using the <code><a href="../reference/get_GSOD.html">get_GSOD()</a></code> function may not work with this many station and year combinations. Often the FTP server becomes overwhelmed and stops responding to requests.</p>
<p>This example shows how you could construct a query using the <code><a href="../reference/get_GSOD.html">get_GSOD()</a></code> function. Be aware that it may result in incomplete data and error from the server. If it does this, see the following option for using the <code><a href="../reference/reformat_GSOD.html">reformat_GSOD()</a></code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/get_GSOD.html">get_GSOD</a></span>(<span class="dt">station =</span> <span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> loop_stations[, <span class="dv">12</span>])), <span class="dt">years =</span> <span class="dv">1960</span><span class="op">:</span><span class="dv">2015</span>,
                              <span class="dt">CSV =</span> <span class="ot">TRUE</span>, <span class="dt">dsn =</span> <span class="st">"~/"</span>,
                              <span class="dt">filename =</span> <span class="st">"Loop_Survey_Weather_1960-1969"</span>)</code></pre></div>
</div>
<div id="another-option" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#another-option" class="anchor"> </a></body></html>Another Option</h2>
<p><code>GSODR</code> provides a function for dealing with local files that have been transfered from the server already as well, <code><a href="../reference/reformat_GSOD.html">reformat_GSOD()</a></code>. If the previous example with <code><a href="../reference/get_GSOD.html">get_GSOD()</a></code> does not work, this is a good alternative that takes a bit more intervention but gives the same results.</p>
<p>Using your FTP client, e.g. FileZilla, log into the NCDC FTP server, &lt;ftp.ncdc.noaa.gov&gt; and navigate to /pub/data/gsod/. Manually downloading the files for each station listed above from 1960 to 2015 is possible, but tedious. An easier solution is to simply download the annual files found in each yearly directory, “gsod-YYYY.tar” and untar them locally and then use R to list the available files and select only the files for the stations of interest. Lastly, write the data to disk as a CSV file for saving and later use.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">years &lt;-<span class="st"> </span><span class="dv">1960</span><span class="op">:</span><span class="dv">2015</span>

loop_stations &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> loop_stations[, <span class="dv">12</span>]))

<span class="co"># create file list</span>
loop_stations &lt;-<span class="st"> </span><span class="kw">do.call</span>(
  paste0, <span class="kw">c</span>(<span class="kw">expand.grid</span>(loop_stations, <span class="st">"-"</span>, years, <span class="st">".op.gz"</span>))
  )

local_files &lt;-<span class="st"> </span><span class="kw">list.files</span>(<span class="dt">path =</span> <span class="st">"./GSOD"</span>, <span class="dt">full.names =</span> <span class="ot">TRUE</span>, <span class="dt">recursive =</span> <span class="ot">TRUE</span>)
local_files &lt;-<span class="st"> </span>local_files[<span class="kw">basename</span>(local_files) <span class="op">%in%</span><span class="st"> </span>loop_stations]

loop_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/reformat_GSOD.html">reformat_GSOD</a></span>(<span class="dt">file_list =</span> local_files)

<span class="kw">write.csv</span>(loop_data, <span class="dt">file =</span> <span class="st">"Loop_Survey_Weather_1960-1969"</span>)</code></pre></div>
</div>
</div>
<div id="notes" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#notes" class="anchor"> </a></body></html>Notes</h1>
<div id="sources" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#sources" class="anchor"> </a></body></html>Sources</h2>
<div id="elevation-values" class="section level4">
<h4 class="hasAnchor">
<html><body><a href="#elevation-values" class="anchor"> </a></body></html>Elevation Values</h4>
<p>90m hole-filled SRTM digital elevation (Jarvis <em>et al.</em> 2008) was used to identify and correct/remove elevation errors in data for station locations between -60˚ and 60˚ latitude. This applies to cases here where elevation was missing in the reported values as well. In case the station reported an elevation and the DEM does not, the station reported is taken. For stations beyond -60˚ and 60˚ latitude, the values are station reported values in every instance. See <a href="https://github.com/ropensci/GSODR/blob/devel/data-raw/fetch_isd-history.md" class="uri">https://github.com/ropensci/GSODR/blob/devel/data-raw/fetch_isd-history.md</a> for more detail on the correction methods.</p>
</div>
</div>
<div id="wmo-resolution-40--noaa-policy" class="section level2">
<h2 class="hasAnchor">
<html><body><a href="#wmo-resolution-40--noaa-policy" class="anchor"> </a></body></html>WMO Resolution 40. NOAA Policy</h2>
<p><em>Users of these data should take into account the following (from the <a href="http://www7.ncdc.noaa.gov/CDO/cdoselect.cmd?datasetabbv=GSOD&amp;countryabbv=&amp;georegionabbv=">NCDC website</a>):</em></p>
<blockquote>
<p>“The following data and products may have conditions placed on their international commercial use. They can be used within the U.S. or for non-commercial international activities without restriction. The non-U.S. data cannot be redistributed for commercial purposes. Re-distribution of these data by others must provide this same notification.” <a href="https://public.wmo.int/en/our-mandate/what-we-do/data-exchange-and-technology-transfer">WMO Resolution 40. NOAA Policy</a></p>
</blockquote>
</div>
</div>
<div id="references" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#references" class="anchor"> </a></body></html>References</h1>
<p>Jarvis, A., Reuter, H.I., Nelson, A., Guevara, E. (2008) Hole-filled SRTM for the globe Version 4, available from the CGIAR-CSI SRTM 90m Database (<a href="http://srtm.csi.cgiar.org" class="uri">http://srtm.csi.cgiar.org</a>)</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#gather-data-for-irri-central-luzon-survey-loop">Gather Data for IRRI Central Luzon Survey Loop</a><ul class="nav nav-pills nav-stacked">
<li><a href="#retrieve-phl-provincial-data-and-select-loop-provinces">Retrieve PHL Provincial Data and Select Loop Provinces</a></li>
      <li><a href="#dissolve-polygons-and-find-centroid-of-loop-survey-area">Dissolve Polygons and Find Centroid of Loop Survey Area</a></li>
      <li><a href="#using-get_gsod-to-fetch-the-requested-station-files">Using get_GSOD to Fetch the Requested Station Files</a></li>
      <li><a href="#another-option">Another Option</a></li>
      </ul>
</li>
      <li>
<a href="#notes">Notes</a><ul class="nav nav-pills nav-stacked">
<li><a href="#sources">Sources</a></li>
      <li><a href="#wmo-resolution-40.-noaa-policy">WMO Resolution 40. NOAA Policy</a></li>
      </ul>
</li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Adam Sparks, Tomislav Hengl, Andrew Nelson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
